<%- include('../partials/head', { pageTitle: 'Galería Colectiva' }) %>
<%- include('../partials/navbar') %>


<main>
  <h1 class="text-center mt-4 mb-4">Galería Colectiva - Webcam Pixelada</h1>
  
  <!-- Canvas p5.js -->
  <div id="sketch-container"></div>

  <!-- Formulario para subir imágenes -->
<div class="container mt-5">
  <h3>Subí tu imagen a la galería colectiva</h3>
  <form action="/obra/sketch3/upload" method="POST" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="userFiles" class="form-label">Elegí una imagen</label>
      <input type="file" name="userFiles" id="userFiles" class="form-control" accept="image/png, image/jpeg" required>
    </div>
    <div class="mb-3">
      <label for="descImg" class="form-label">Descripción</label>
      <input type="text" name="descImg" id="descImg" class="form-control" required>
    </div>
    <button type="submit" class="btn btn-primary">Subir imagen</button>
  </form>
</div>

<!-- Galería de imágenes subidas -->
<div class="container mt-5">
  <h3>Imágenes en la galería colectiva</h3>
  <div class="row">
    <% if (locals.images && images.length > 0) { %>
      <% for(let img of images) { %>
        <div class="col-md-4 mb-4">
          <img src="/uploads/<%= img.filehash %>" class="img-fluid" alt="<%= img.filedesc %>">
          <p class="text-muted mt-2"><strong><%= img.username %>:</strong> <%= img.filedesc %></p>
        </div>
      <% } %>
    <% } else { %>
      <p>Todavía no hay imágenes en la galería. ¡Sé el primero en subir una!</p>
    <% } %>
  </div>
</div>
  


<!-- p5.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>

<script>
let angle = 0;
let radius = 1;
let spacing = 0.005; // velocidad de expansión
let step = 0.05;     // paso angular
let cam;
let jsonData = [];
  
function preload() {}
  loadJSON("/obra/data", data => {
    for(let obj of data) {
      obj.img = loadImage(obj.filehash);  // Cargamos la imagen desde el servidor en preload porque son acciones async.
      jsonData.push(obj);  // Se guardan los objetos en un array.
    }
  });

function setup() {
  let canvas = createCanvas(600, 600);
  canvas.parent('sketch-container');

  cam = createCapture(VIDEO);
  cam.size(600, 600);
  cam.hide();
  strokeWeight(1.5);
  noFill();
  
  // Botón guardar
  let guardarBtn = createButton('Guardar Imagen');
  guardarBtn.parent('sketch-container');
  guardarBtn.position(200, height - 200 );
  guardarBtn.mousePressed(guardarFrame);
  guardarBtn.class('btn-sketch');
  
  // Botón invertir
  let invertirBtn = createButton('Invertir Colores');
  invertirBtn.parent('sketch-container');
  invertirBtn.position(1550, height - 200);
  invertirBtn.mousePressed(toggleInvertir);
  invertirBtn.class('btn-sketch');
}

function draw() {
  background(255);
  cam.loadPixels();

  push();
  translate(width / 2, height / 2);
  let a = angle;
  let r = radius;

  for (let i = 0; i < 70000; i++) {
    let x = cos(a) * r;
    let y = sin(a) * r;

    // coordenadas espejo para la cámara
    let px = floor(width - (width / 2 + x));
    let py = floor(height / 2 + y);

    if (px >= 0 && px < cam.width && py >= 0 && py < cam.height) {
      let index = (py * cam.width + px) * 4;
      let bright = (cam.pixels[index] + cam.pixels[index + 1] + cam.pixels[index + 2]) / 3;

       // color y opacidad según brillo
      if (bright < 100) {
        stroke(0, 70, 255, random(180, 255));
        strokeWeight(random(1.2, 2));
      } else if (bright < 180) {
        stroke(100, 140, 255, random(80, 180));
        strokeWeight(random(0.8, 1.5));
      } else {
        stroke(255, 255, 255, 0);
        strokeWeight(0);
      }
      point(x, y);
    }

    r += spacing;
    a += 0.05 / sqrt(r + 10);
  }
  pop();

  angle += 0.001; // ligera rotación del patrón

}

function guardarFrame() {
  saveCanvas('captura_video', 'png');
}

function toggleInvertir() {
  invertirColores
  = !invertirColores;
}
</script>
</main>

<%- include('../partials/foot') %>